## grouped tasks

["setup"]
depends = ["*:setup"]

["check"]
depends = ["*:check"]

["fix"]
depends = ["*:fix"]

["test"]
depends = ["*:test"]

## git hooks

["git-hooks:pre-commit"]
hide = true
depends = ["check"]

## common tasks

### setup

["common:setup"]
depends = ["common:setup:*"]

["common:setup:mise-local-toml"]
hide = true
dir = "{{config_root}}"
run = "test -f mise.local.toml || cp mise.local.toml-example mise.local.toml"
sources = ["mise.local.toml-example"]
outputs = { auto = true }

["common:setup:git-hooks"]
hide = true
dir = "{{config_root}}"
run = "test ! -d .git || (printf '#!/bin/sh\n{{ mise_bin }} run git-hooks:pre-commit' >.git/hooks/pre-commit && chmod +x .git/hooks/pre-commit)"
sources = [".git/hooks/pre-commit"]
outputs = { auto = true }

["common:setup:pnpm"]
hide = true
dir = "{{config_root}}"
run = "pnpm install"
sources = ["pnpm-lock.yaml", "pnpm-workspace.yaml", "apps/*/package.json", "docs/package.json", "agents/*/*/package.json"]
outputs = { auto = true }

### check

["common:check"]
depends = ["common:check:*"]

["common:check:license"]
dir = "{{config_root}}"
run = "addlicense -check -l apache -s=only -c '¬© BeeAI a Series of LF Projects, LLC' $(fd '\\.(py|[jt]sx?|html|s?css)$')"

["common:check:version"]
dir = "{{config_root}}"
run = '''
#!/usr/bin/env bash
set -euo pipefail
version=$(
  {
    yq -r .version              helm/Chart.yaml
    yq -r .appVersion           helm/Chart.yaml
    yq -r .project.version      apps/agentstack-cli/pyproject.toml
    yq -r .project.version      apps/agentstack-sdk-py/pyproject.toml
    yq -r .version              apps/agentstack-sdk-ts/package.json
    yq -r .project.version      apps/agentstack-server/pyproject.toml
    yq -r .version              apps/agentstack-ui/package.json
    yq -r .version              apps/beeai-web/package.json
    yq -r '.providers[].location | split(":")[-1]' agent-registry.yaml
  } | sort -u
)
if [[ $(wc -l <<<"$version") -ne 1 ]]; then echo "ERROR: Version mismatch detected: $(echo $version)" >&2; exit 1; fi
if ! [[ $version =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then echo "ERROR: $version is not valid semver (X.Y.Z or X.Y.Z-rcN)" >&2; exit 1; fi
if [[ "${GITHUB_REF:-}" == refs/tags/* ]] && [[ $GITHUB_REF != "refs/tags/v$version" ]]; then echo "ERROR: GITHUB_REF '$GITHUB_REF' does not match 'refs/tags/v$version'" >&2; exit 1; fi
'''

### fix

["common:fix"]
depends = ["common:fix:*"]

["common:fix:license"]
dir = "{{config_root}}"
run = "addlicense -l apache -s=only -c '¬© BeeAI a Series of LF Projects, LLC' $(fd '\\.(py|[jt]sx?|html|s?css)$')"

### test

["common:test"]
run = "true" # Empty tests in case there are no tests

# Platform tasks

["agentstack:start"]
depends = ["agentstack-server:build", "supergateway:build"]
dir = "{{config_root}}"
run = """
#!/bin/bash
set -e

UI_IMPORT=""
UI_TAG=""

if [[ ! "$*" =~ 'ui.enabled=false' ]]; then
    {{ mise_bin }} run agentstack-ui:build
    UI_IMPORT="--import ghcr.io/i-am-bee/agentstack/agentstack-ui:local"
    UI_TAG="--set ui.image.tag=local"
fi

{{ mise_bin }} run agentstack-cli:run -- platform start \
    --import "ghcr.io/i-am-bee/agentstack/agentstack-server:local" \
    --import "ghcr.io/i-am-bee/agentstack/supergateway:latest" \
    $UI_IMPORT \
    --set image.tag=local \
    $UI_TAG "$@"
"""

["agentstack:delete"]
run = "{{ mise_bin }} run agentstack-cli:run -- platform delete"

["agentstack:stop"]
run = "{{ mise_bin }} run agentstack-cli:run -- platform stop"


["agentstack:stop-all"]
run = """
#!/bin/bash
# Stop all lima VMs

EXCEPT='{{option(name="except", default="")}}'

{% raw %}
TO_STOP="$(LIMA_HOME=~/.agentstack/lima limactl list -f '{{.Name}};{{.Status}}' | grep -v "Stopped" | cut -d';' -f1 2>/dev/null | sed '/^[^a-z]*$/d' | sed "/^$EXCEPT$/d")"
{% endraw %}

{% raw %}
echo "$TO_STOP" | xargs -rn 1 -I"{}" mise run agentstack-cli:run -- platform stop --vm-name="{}"
{% endraw %}
"""

["agentstack:shell"]
raw = true
shell = "echo"
dir = "{{cwd}}"
run = """
deactivate () {
  export PS1="$__OLD_PS1"

  # Restore LIMA_HOME to its original state (set or unset)
  [[ -n "$__OLD_LIMA_HOME" ]] && export LIMA_HOME="$__OLD_LIMA_HOME" || unset LIMA_HOME
  [[ -n "$__OLD_KUBECONFIG" ]] && export KUBECONFIG="$__OLD_KUBECONFIG" || unset KUBECONFIG
  [[ -n "$__OLD_ADMIN_PASSWORD" ]] && export AGENTSTACK__ADMIN_PASSWORD="$__OLD_ADMIN_PASSWORD" || unset AGENTSTACK__ADMIN_PASSWORD

  # Clean up the backup values
  unset __OLD_PS1
  unset __OLD_LIMA_HOME
  unset __OLD_KUBECONFIG
  unset __OLD_ADMIN_PASSWORD
  unset -f deactivate
  echo "Environment for '$VM_NAME' deactivated."
}

while [[ -n "$__OLD_PS1" ]]; do
  deactivate;
done

VM_NAME={{option(name="vm-name", default="agentstack")}}
echo "Activating environment for '$VM_NAME'..."

export __OLD_PS1="$PS1"
export __OLD_LIMA_HOME="$LIMA_HOME"
export __OLD_KUBECONFIG="$KUBECONFIG"
export __OLD_ADMIN_PASSWORD="$AGENTSTACK__ADMIN_PASSWORD"

export KUBECONFIG="${AGENTSTACK__HOME:-${HOME}/.agentstack}/lima/${VM_NAME}/copied-from-guest/kubeconfig.yaml"
export LIMA_HOME=${AGENTSTACK__HOME:-${HOME}/.agentstack}/lima
export AGENTSTACK__ADMIN_PASSWORD=test-password
export PS1="(${VM_NAME}) ${__OLD_PS1}"

"""

["release:new"]
dir = "{{config_root}}"
run = '''
#!/bin/bash
set -eu -o pipefail

if [[ -n "$(git status --porcelain)" ]]; then
  echo "ERROR: Working directory not clean"
  exit 1
 fi



current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" != "main" ]]; then
  echo "ERROR: You must be on the 'main' branch (current: $current_branch)"
  exit 1
fi

current_version=$(yq -r '.version' helm/Chart.yaml)
rc_version="${current_version}-rc1"

if [[ "$current_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
  major="${BASH_REMATCH[1]}"
  minor="${BASH_REMATCH[2]}"
  patch="${BASH_REMATCH[3]}"
  next_version="${major}.${minor}.$((patch + 1))"
else
  echo "ERROR: Invalid version format: $current_version. Expected format: X.Y.Z"
  exit 1
fi

# Show what will happen and ask for confirmation
echo "  Current version (main): $current_version"
echo ""
echo "  Actions:"
echo "  1. Create RC in release branch: $rc_version"
echo "  2. Bump version in main branch: $next_version"
echo ""

if ! gum confirm "Proceed with the release?"; then
  echo "Release cancelled."
  exit 0
fi

git checkout release
git reset --hard origin/main

{{ mise_bin }} release:bump --version="$rc_version"

git checkout main
git pull origin main

# Bump version on main
{{ mise_bin }} release:bump --version="$next_version"
'''

["release:_update-install-sh"]
hide = true
dir = "{{config_root}}"
run = '''
#!/bin/bash
set -eu -o pipefail

version='{{option(name="version", required=true)}}'

# Update install.sh based on version type
if [[ "$version" == *"-rc"* ]]; then
  # RC version - update LATEST_AGENTSTACK_VERSION only
  perl -pi -e "s/^(LATEST_AGENTSTACK_VERSION=).*/\${1}$version/" install.sh
else
  # Stable version - update BOTH constants (stable becomes new latest)
  perl -pi -e "s/^(LATEST_STABLE_AGENTSTACK_VERSION=).*/\${1}$version/" install.sh
  perl -pi -e "s/^(LATEST_AGENTSTACK_VERSION=).*/\${1}$version/" install.sh
fi

echo "Updated install.sh version constants for: $version"
'''

["release:bump"]
dir = "{{config_root}}"
run = '''
#!/bin/bash
set -eu -o pipefail

# Get version parameter
new_version='{{option(name="version", required=true)}}'

# Validate version format (X.Y.Z or X.Y.Z-rcW)
if ! [[ "$new_version" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-rc[0-9]+)?$ ]]; then
  echo "ERROR: Invalid version format: $new_version"
  echo "Expected format: X.Y.Z or X.Y.Z-rcW (e.g., 1.2.3 or 1.2.3-rc1)"
  exit 1
fi

echo "Updating version to $new_version..."

# Update all version fields
yq -i ".version = \"$new_version\"" helm/Chart.yaml
yq -i ".appVersion = \"$new_version\"" helm/Chart.yaml
(cd apps/agentstack-sdk-py && toml set 'project.version' "$new_version" --toml-path pyproject.toml && uv lock)
(cd apps/agentstack-cli && toml set 'project.version' "$new_version" --toml-path pyproject.toml && uv lock)
(cd apps/agentstack-server && toml set 'project.version' "$new_version" --toml-path pyproject.toml && uv lock)
for agent in agents/*; do (cd $agent && uv lock); done
yq -i ".version = \"$new_version\"" apps/agentstack-sdk-ts/package.json
yq -i ".version = \"$new_version\"" apps/agentstack-ui/package.json
yq -i ".version = \"$new_version\"" apps/beeai-web/package.json
yq -i ".providers[].location |= sub(\":(.*)\$\"; \":\" + \"$new_version\")" agent-registry.yaml

{{ mise_bin }} release:_update-install-sh --version="$new_version"

git add .
git commit -m "bump: v$new_version"

current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" == "release" ]]; then
  echo "On release branch, tagging and pushing tag..."
  git tag "v$new_version"
  git push origin tag "v$new_version"
  echo "‚úÖ Version updated to $new_version, tagged and pushed"
elif [[ "$current_branch" == "main" ]]; then
  echo "On main branch, pushing to origin..."
  git push origin main
  echo "‚úÖ Version updated to $new_version, committed and pushed to main"
else
  echo "ERROR: Cannot push from branch '$current_branch'. Only 'release' and 'main' branches are supported."
  exit 1
fi
'''

["release:publish"]
dir = "{{config_root}}"
run = '''
#!/bin/bash
set -eu -o pipefail

# Ensure on release branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [[ "$current_branch" != "release" ]]; then
  echo "ERROR: You must be on the 'release' branch (current: $current_branch)"
  exit 1
fi

# Ensure working directory is clean
if [[ -n "$(git status --porcelain)" ]]; then
  echo "ERROR: Working directory not clean"
  git status
  exit 1
fi

current_version=$(yq -r '.version' helm/Chart.yaml)
publish_version="${current_version%-rc*}"

# Confirm commit and push
if gum confirm "Publish version $publish_version now?"; then
  (
    set -eux -o pipefail
    {{ mise_bin }} release:bump --version="$publish_version"

    git add .
    git commit -m "deploy: v$publish_version"
    git tag "v$publish_version"
    git push origin tag "v$publish_version"
    git push origin release
  )
  
  # Backport install.sh version updates to main branch
  echo "Backporting install.sh version updates to main branch..."
  (
    set -eux -o pipefail
    git checkout main
    git pull origin main

    {{ mise_bin }} release:_update-install-sh --version="$publish_version"

    git add install.sh
    git commit -m "chore: update install.sh version to v$publish_version"
    git push origin main
    git checkout release
  )
  
  if command -v gh >/dev/null; then
    gum spin --title="Waiting for GitHub Action to start..." sleep 10
    gh run watch $(gh run list --workflow=Release --branch=v$publish_version --limit=1 --json databaseId,status -q '.[0].databaseId') || true
  fi
  echo "GitHub action started. Check the progress and result on: https://github.com/i-am-bee/agentstack/actions/workflows/release.yml"
fi
'''

["sync-images-to-ghcr"]
dir = "{{config_root}}"
depends = ["helm:build:dependencies"]
run = '''
#!/bin/bash

set -euo pipefail
DRY_RUN='{{flag(name='dryrun')}}'

{% raw %}
echo "Extracting images from helm chart..."

# Extract images from helm chart
images=$(helm template \
  --set phoenix.enabled=true \
  --set encryptionKey=dummy \
  --set auth.enabled=false \
  --set auth.jwtSecretKey=kyticka \
  --set providerBuilds.enabled=true \
  --set localDockerRegistry.enabled=true \
  ./helm 2>/dev/null | \
    sed -n '/^[[:space:]]*image:/{ /{{/d; s/.*image:[[:space:]]*//p; }' | \
    sed 's/"\([^"]*\)"/\1/' | grep -v 'agentstack')

echo "Found images:"
echo "$images"

# Process each image
echo "$images" | while IFS= read -r ghcr_image; do
  if [[ -z "$ghcr_image" ]]; then
    continue
  fi

  echo "Processing image: $ghcr_image"

  # Remove ghcr.io/i-am-bee/ prefix to get Docker Hub image
  if [[ $ghcr_image =~ ^ghcr\.io/i-am-bee/(.+)$ ]]; then
    dockerhub_image="${BASH_REMATCH[1]}"

    echo "GHCR image: $ghcr_image"
    echo "Docker Hub image: $dockerhub_image"

    # Check if image exists in GHCR
    if docker manifest inspect "$ghcr_image" >/dev/null 2>&1; then
      echo "‚úÖ Image $ghcr_image already exists in GHCR"
      continue
    fi

    echo "‚ùå Image $ghcr_image not found in GHCR"

    if [[ "$DRY_RUN" == "true" ]]; then
      echo "üîç DRY RUN: Would sync $dockerhub_image -> $ghcr_image"
      continue
    fi

    # Check if source image exists in Docker Hub
    if ! docker manifest inspect "$dockerhub_image" >/dev/null 2>&1; then
      echo "‚ùå Source image $dockerhub_image not found in Docker Hub"
      continue
    fi

    echo "üîÑ Syncing $dockerhub_image -> $ghcr_image"

    # Copy image with all architectures using skopeo
    skopeo copy --multi-arch all docker://"$dockerhub_image" docker://"$ghcr_image"

    echo "‚úÖ Successfully synced $ghcr_image"
  else
    echo "‚ö†Ô∏è  Skipping image with unexpected format: $ghcr_image"
  fi
done

echo "Image sync completed!"
{% endraw %}
'''