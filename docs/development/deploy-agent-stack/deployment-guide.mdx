---
title: "Agent Stack Deployment Guide"
description: "Deploy Agent Stack to Kubernetes with Helm for internal team use"
---

Deploy Agent Stack on Kubernetes using Helm to create a centralized environment where your team can quickly test, share, and iterate on agents.

<Warning>
  **Intended Use:** Agent Stack is designed for internal team deployments behind
  VPNs or firewalls. Basic authentication protects administrative operations
  (agent management, secrets, model configuration), but authenticated users can
  freely use agents, upload files, and create vector stores without per-user
  limits. Deploy only in trusted environments where you control who has access.
  Public internet deployments are not recommended.
</Warning>

## Requirements

- Agent Stack installed for post-deployment configuration
- Kubernetes 1.24+ with admin access
- kubectl configured to access your cluster
- Helm 3.8+
- Persistent storage (20GB+ for PostgreSQL)
- LLM provider API access (OpenAI, Anthropic, etc.)

<Warning>
  **OpenShift**: Use [OpenShift
  CLI](https://docs.redhat.com/en/documentation/openshift_container_platform/4.20/html/cli_tools/openshift-cli-oc)
  for login and administration.
</Warning>

## Get Started

### Step 1: Create Configuration File

Create a `config.yaml` file with your desired configuration, here is a minimal example, more advanced options
are explained in the [Configuration Options](#configuration-options) section.

```yaml
# If you want to include agents from the default catalog (change release/tag accordingly):
externalRegistries:
  public_github: "https://github.com/i-am-bee/agentstack@v0.4.3#path=agent-registry.yaml"

# Your custom agents as docker images
providers:
  # e.g.
  # - location: ghcr.io/i-am-bee/agentstack-starter/my-agent:latest
  - location: <docker-image-id>

# Generate the encryption key:
#  - using UV (https://docs.astral.sh/uv/getting-started/installation/)
#   $ uv run --with cryptography python3 -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'
#  - using python3 directly
#   $ python3 -m pip install cryptography # (or use your preferred way to install the cryptography package)
#   $ python3 -c 'from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())'
encryptionKey: "encryption-key-from-command"

# This requires passing an admin password to certain endpoints, you can disable auth for insecure deployments
auth:
  enabled: true
  basic:
    enabled: true
    adminPassword: "my-secret-password"
```

### Step 2: Install the Chart

Then install the chart using:

```shell
helm upgrade --install agentstack -f config.yaml oci://ghcr.io/i-am-bee/agentstack/chart/agentstack:0.4.3
```

It will take a few minutes for the pods to start.

### Step 3: Port-Forwarding

By default, ingress is not configured. You can port-forward the service to access the platform.
In a separate terminal, run:

```shell
kubectl port-forward svc/agentstack-svc 8333:8333 &
```

### Step 4: Setup LLM

After the platform becomes ready, it's time to set up your model provider:

```shell
# agentstack server login (if auth is enabled)
agentstack model setup
```

### Step 5: Test the Deployment

```shell
agentstack list
agentstack run chat hi
```

## Configuration Options

### Security Settings

<Warning>
  The current authentication model is basic and intended for development use.
  For any deployment beyond local testing, carefully consider your security
  requirements and network access controls.
</Warning>

#### Disable authentication

For local testing environments without authentication:

```yaml
# CAUTION: INSECURE, for testing only
auth:
  enabled: false
```

#### OIDC authentication (via Keycloak)

We use an internal Keycloak instance to handle OIDC authentication. This allows you to configure external Identity Providers (Google, GitHub, SAML, etc.) directly within Keycloak.

```yaml
trustProxyHeaders: true # This is important if validate_audience is enabled

auth:
  enabled: true
  # Check helm/values.yaml for all available options
  keycloakIssuerUrl: "https://keycloak.myapp.com/realms/agentstack" # Public URL of keycloak
  
  # Next.js settings
  nextauthUrl: "https://myapp.com" # Public URL of the UI
  apiUrl: "https://api.myapp.com" # Public URL of the API
```
  
<Warning>
It is important to expose the following endpoints publicly and configure the value above:

- UI (https://myapp.com)
- API (https://api.myapp.com) - used by the CLI to authenticate
- Keycloak (https://keycloak.myapp.com) - used by the UI and CLI to authenticate

Use
[ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/), 
[gateway API](https://kubernetes.io/docs/concepts/services-networking/gateway/),
[openshift routes](https://docs.redhat.com/en/documentation/openshift_container_platform/4.20/html/ingress_and_load_balancing/routes)
or other tools to expose the services.

⚠️ Failure to configure these endpints with proper https may leave your application vulnerable.

</Warning>

Keycloak is deployed automatically when `auth.enabled` is `true`.

**Accessing Keycloak:**
- **Local Port-Forward:** `kubectl port-forward svc/agentstack-keycloak 8336:8336` -> Access at `http://localhost:8336`
- **Production:** Create an [Ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/) for the `agentstack-keycloak` service.

**Configuration:**
1.  Log in to Keycloak (default credentials: `admin` / retrieve from secret).
2.  Navigate to **Identity Providers**.
3.  Add your external provider (e.g., GitHub, Google).

<Warning>
**Email Verification Required:** Agent Stack requires the `email_verified` claim to be `true` in JWT tokens. When configuring external identity providers in Keycloak, ensure that:
- Users verify their email addresses before authenticating
- The `email_verified` claim is mapped to the token (this is included by default in the `email` scope)
- External providers pass the email verification status correctly

Without verified emails, authentication will fail with "Verified email not found" error.
</Warning>

<details>
<summary>Keycloak Architecture & Roles</summary>

The Agent Stack Keycloak integration is automatically provisioned with the following architecture:

**Realm:** `agentstack`

**Clients:**
- `agentstack-server`: Backend service client (Confidential, Service Accounts enabled).
- `agentstack-ui`: Frontend UI client (Confidential, Standard Flow).
- `agentstack-cli`: Command Line Interface client (Public, Standard Flow).

**Roles:**
- `agentstack-admin`: Full system access.
- `agentstack-developer`: access to agent management.

**Audiences:**
Audience mappers are dynamically configured to ensure tokens are valid for the specific service URLs (UI, API) defined in your configuration.
</details>



### Rate Limiting

Rate limiting is recommended for production environments as a protection against overloading the platform.

```yaml
rateLimit:
  enabled: true
  globalLimits:
    - "20/second"
    - "100/minute"
  roleBasedLimits:
    user:
      openai_chat_completion_tokens: []
      openai_chat_completion_requests: []
      openai_embedding_inputs: []
    developer:
      openai_chat_completion_tokens: []
      openai_chat_completion_requests: []
      openai_embedding_inputs: []
    admin:
      openai_chat_completion_tokens: []
      openai_chat_completion_requests: []
      openai_embedding_inputs: []
  strategy: "sliding-window-counter" # Options: fixed-window, moving-window, sliding-window-counter
```

<Warning>
  If you are running multiple replicas (`replicaCount` > 1), Redis is
  **required** for rate limiting to work correctly across all instances. Without
  Redis, each replica maintains its own rate limit counters, allowing users to
  exceed limits by distributing requests across replicas.
</Warning>

### CORS Configuration

Agent Stack supports Cross-Origin Resource Sharing (CORS) to allow web applications hosted on different domains to interact with the Agent Stack API.

```yaml
cors:
  enabled: true
  allowOrigins:
    - http://localhost:3000
    - https://my-ui.example.com
  allowMethods:
    - GET
    - POST
    - PUT
    - DELETE
    - OPTIONS
  allowHeaders:
    - Content-Type
    - Authorization
  allowCredentials: true
```

- `cors.enabled`: Set to `true` to enable CORS. Default is `false`.
- `cors.allowOrigins`: A list of origins (e.g., `http://localhost:3000`) that are allowed to make cross-site requests to the Agent Stack API.
- `cors.allowMethods`: A list of HTTP methods (e.g., `GET`, `POST`) that are allowed for cross-origin requests. Default is `["*"]`.
- `cors.allowHeaders`: A list of HTTP request headers (e.g., `Content-Type`, `Authorization`) that can be used when making the actual cross-origin request. Default is `["*"]`.
- `cors.allowCredentials`: Set to `true` to indicate that the client can send cookies and HTTP authentication credentials with the cross-origin request. Note that `allowOrigins` cannot be `["*"]` when `allowCredentials` is `true`. Default is `false`.

### Exposing the platform

Ingress is not configured by default. You can expose the following services using your preferred way.

- `agentstack-ui-svc`: access to the UI (which includes the API proxy)
- `agentstack-server-svc` (optional): direct access to the server API, required for CLI

Typically, this means creating a custom [ingress](https://kubernetes.io/docs/concepts/services-networking/ingress/).

<Warning>
  **OpenShift**:
  [Routes](https://docs.redhat.com/en/documentation/openshift_container_platform/4.20/html/ingress_and_load_balancing/configuring-routes)
  can be used instead of ingress.
</Warning>

### Agent Configuration

You can add specific agents directly or use a remote registry to sync agents from an external catalog.

#### Specify agents statically

Configure specific agents in your deployment:

```yaml
providers:
  # Official agents
  - location: ghcr.io/i-am-bee/agentstack/agents/chat:0.4.3
  - location: ghcr.io/i-am-bee/agentstack/agents/rag:0.4.3
  - location: ghcr.io/i-am-bee/agentstack/agents/form:0.4.3

  # Your custom agents
  - location: your-registry.com/your-team/custom-agent:v1.0.0
    auto_stop_timeout_sec: 0 # disable agent downscaling
    # Variables should be strings (or they will be converted)
    variables:
      MY_API_KEY: "sk-..."
      MY_CONFIG_VAR: "42"
```

To upgrade an agent, change its version tag and redeploy using `helm upgrade`.

#### External Agent Registry

You can use the concept of agent registries instead of specifying individual agents:

```yaml
externalRegistries:
  public_github: "https://github.com/i-am-bee/agentstack@v0.4.3#path=agent-registry.yaml"
```

To upgrade an agent, change its version in the registry and wait for automatic synchronization (up to 10 minutes).

### Agent builds

Agents can be built from a GitHub repository directly in the cluster. To enable this feature, you will need to
setup a few things:

- docker image registry credentials with write permissions, see [Private image registries](#private-image-registries)
- [optional] github credentials (optional) to access private or enterprise GitHub repositories
- [optional] external cluster (optional) for better security

<Warning>
  **OpenShift**: It is also necessary to setup a service account with
  appropriate [SCC](https://www.redhat.com/en/blog/managing-sccs-in-openshift)
  to allow elevated container permissions.
</Warning>

```yaml
providerBuilds:
  enabled: true
  buildBackend: "kaniko" # valid options: [kaniko, buildkit]
  buildRegistry:
    registryPrefix: "ghcr.io/github-org-name"
    imageFormat: "{registry_prefix}/{org}/{repo}/{path}:{commit_hash}"
    # Registry credentials with write access (see section about Private image registries below)
    secretName: "custom-registry-secret"
    insecure: false
  kaniko:
    useSecurityContextCapabilities: true
  externalClusterExecutor:
    serviceAccountName: ""
    namespace: "" # Kubernetes namespace for provider builds (defaults to current namespace if empty)
    kubeconfig: "" # Kubeconfig YAML content for external cluster (optional)
    # Example:
    # kubeconfig: |
    #   apiVersion: v1
    #   kind: Config
    #   clusters:
    #   - cluster:
    #       server: https://kubernetes.example.com
    #   ...
```

### Configuring external services

You may want to access or build agents from private registries or GitHub repositories, here is how to
configure these options.

#### Private image registries

You can configure pull secrets to access agents in private docker registries using:

```yaml
imagePullSecrets:
  - name: custom-registry-secret
```

where `custom-registry-secret` is the name of a kubernetes secret created according to the official
[documentation](https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/).

#### Private github repositories

If you want to build agents from enterprise github or private github repositories, you can either create a
[Personal Access Token (PAT)](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)
or use a [GitHub App](https://docs.github.com/en/apps/creating-github-apps/about-creating-github-apps/about-creating-github-apps)
to access the repository. The configuration looks as follows:

```yaml
github:
  auths:
    github.com:
      type: "pat"
      token: "ghp_xxxxxxxxxxxxxxxxxxxx"
    github.enterprise.com:
      type: "app"
      app_id: 123456
      installation_id: 789012
      private_key: |
        -----BEGIN RSA PRIVATE KEY-----
        MIIEpAIBAAKCAQEA...
        -----END RSA PRIVATE KEY-----
```

### Storage

By default, Agent Stack deployment includes postgresql and seaweedfs (s3 compatible object storage). It is not
recommended to use these builtin versions of services in production. Instead, you should configure external databases
(ideally managed by a cloud provider).

#### External PostgreSQL

If you prefer to use an external PostgreSQL instance instead of provisioning a new one within the cluster,
you can disable the built-in PostgreSQL and provide the required connection details using the `externalDatabase` section.
Below is an example configuration:

```yaml
postgresql:
  enabled: false # disable builtin subchart
externalDatabase:
  host: "<your-postgres-host>"
  port: 5432
  user: "<your-postgres-user>"
  database: "<your-postgres-database>"
  password: "<your-postgres-password>"
  # Required when initContainers.createVectorDbExtension is enabled
  adminUser: "<postgres-admin-user>"
  adminPassword: "<postgres-admin-password>"
  ssl: true
  sslRootCert: ""
  # SSL certificate for the external database to ensure ssl connection, for example:
  # sslRootCert: |
  #   -----BEGIN CERTIFICATE-----
  #   ...
  #   -----END CERTIFICATE-----
```

If you encounter issues with installing `vector` extension during db migration, you can disable the creation by:

```console
initContainers.createVectorDbExtension=false
```

Then make sure the following SQL statements were executed in your database:

```sql
CREATE EXTENSION IF NOT EXISTS vector;
SET maintenance_work_mem = '512MB';
SET hnsw.ef_search = 1000;
SET hnsw.iterative_scan = strict_order;
SET hnsw.max_scan_tuples = 1000000;
```

#### Redis

Agent Stack supports Redis for rate limiting and caching. This feature is disabled by default, but required if replicaCount > 1.
You can use the built-in Redis subchart or connect to an external instance.

**Enable Built-in Redis:**

```yaml
redis:
  enabled: true
```

**External Redis:**

To use an external Redis instance, ensure the built-in subchart is disabled (default) and provide connection details:

```yaml
redis:
  enabled: false
externalRedis:
  host: "<your-redis-host>"
  port: 6379
  password: "<your-redis-password>"
  # Optional: use existing secret for password
  # existingSecret: "my-redis-secret"
  # existingSecretPasswordKey: "redis-password"
```

#### External S3 support

You may want to have Agent Stack connect to an external object storage rather than installing seaweedfs inside
your cluster. To achieve this, the chart allows you to specify credentials for an external storage streaming with the
`externalS3`. You should also disable the seaweedfs installation with the `seaweedfs.enabled`
option. Here is an example:

```console
seaweedfs:
    enabled: false
externalS3:
    host: <your-s3-host>
    accessKeyID: <your-s3-access-key>
    accessKeySecret: <your-s3-acess-key-secret>
```

### Advanced Configuration

The list of all configuration options is available in the
[values.yaml](https://github.com/i-am-bee/agentstack/blob/v0.4.3/helm/values.yaml) file. If you have specific
requirements for the helm chart configuration which are not covered by the current options, please open an issue.

## Management Commands

### Upgrading

To upgrade to a newer version of the Agent Stack, use:

```shell
helm upgrade --install agentstack -f config.yaml oci://ghcr.io/i-am-bee/agentstack/chart/agentstack:<newer-version>
```

### View Current Configuration

```bash
helm get values agentstack
```

### Check Deployment Status

```bash
helm status agentstack
kubectl get pods
kubectl logs deployment/agentstack-server
```

### Uninstall

```bash
helm uninstall agentstack
```

## Troubleshooting

### Common Issues

**Platform not starting:**

```bash
# Check pod status
kubectl get pod

# Check server logs
kubectl logs deployment/agentstack-server
# If server is not starting, check specific init container logs (e.g. migrations)
kubectl logs deployment/agentstack-server -c run-migrations

# Check events
kubectl get events --sort-by=.lastTimestamp
```

**Authentication issues:**

Make sure you have configured your OIDC provider correctly:

- redirect URI should be the public URL + `/api/auth/callback` (e.g. `https://your-public-url.com/api/auth/callback`)
- for CLI, the redirect URI should be `http://localhost:9001/callback`
- consider creating a separate public OIDC application for the CLI
- `audience` claim should be the public URL of your application without a trailing slash (e.g. `https://example.com`)
- `trustProxyHeaders` must be enabled to correctly forward the request URL through proxies
- if this is still not working, try to disable `auth.oidc.validate_audience`
