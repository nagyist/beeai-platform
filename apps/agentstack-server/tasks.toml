# setup

["agentstack-server:setup"]
extends = "python:setup"
depends = ["agentstack-sdk-py:setup"]
dir = "{{config_root}}/apps/agentstack-server"

# check
["agentstack-server:test"]
depends = ["agentstack-server:test:unit"]

["agentstack-server:check"]
depends = ["agentstack-server:check:*"]

["agentstack-server:check:pytest-marks"]
extends = "python:check:pytest-marks"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

["agentstack-server:check:ruff-check"]
extends = "python:check:ruff"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

["agentstack-server:check:ruff-format"]
extends = "python:check:ruff-format"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

["agentstack-server:check:pyrefly"]
extends = "python:check:pyrefly"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

["agentstack-server:check:hadolint"]
extends = "docker:check:hadolint"
dir = "{{config_root}}/apps/agentstack-server"

# fix

["agentstack-server:fix"]
depends = ["agentstack-server:fix:*"]

["agentstack-server:fix:ruff-check"]
extends = "python:fix:ruff"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

["agentstack-server:fix:ruff-format"]
extends = "python:fix:ruff-format"
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"

#Â run

["agentstack-server:run"]
depends = ["agentstack-server:setup", "supergateway:build"]
dir = "{{config_root}}/apps/agentstack-server"
run = "uv run agentstack-server"

# build

["agentstack-server:build"]
depends = ["agentstack-server:build:*"]
dir = "{{config_root}}/apps/agentstack-server"
run = "docker build -t ghcr.io/i-am-bee/agentstack/agentstack-server:local --load ."

["agentstack-server:build:requirements"]
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"
run = "mkdir -p dist && uv export --no-hashes --no-emit-workspace --no-dev --format requirements-txt > dist/requirements.txt"
sources = ["uv.lock"]
outputs = ["dist/requirements.txt"]

["agentstack-server:build:sdist"]
depends = ["agentstack-server:setup"]
dir = "{{config_root}}/apps/agentstack-server"
run = "rm ./dist/*.tar.gz 2>/dev/null || true; uv build --sdist --out-dir dist"
sources = ["pyproject.toml", "uv.lock", "src/**/*.py"]
outputs = ["dist/*.tar.gz"]

# migrations

["agentstack-server:migrations:run"]
dir = "{{config_root}}/apps/agentstack-server"
run = "uv run migrate"

["agentstack-server:migrations:alembic:nocheck"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'arg "[alembic_vars]..."'
run = """
#!/bin/bash
set -a
source .env
set +a

cd src/agentstack_server/infrastructure/persistence/migrations
eval "alembic_vars=(${usage_alembic_vars})"
uv run alembic "${alembic_vars[@]}"
"""

["agentstack-server:migrations:alembic"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'arg "[alembic_vars]..."'
run = """
#!/bin/bash
set -a
source .env
set +a

if ! telepresence list --replacements 2>/dev/null | grep -q agentstack; then
    echo "Dev env not running, use 'mise run agentstack-server:dev:start' to start it..."
    exit 1
fi

cd src/agentstack_server/infrastructure/persistence/migrations
eval "alembic_vars=(${usage_alembic_vars})"
uv run alembic "${alembic_vars[@]}"
"""

["agentstack-server:migrations:generate"]
dir = "{{config_root}}/apps/agentstack-server"
run = "{{ mise_bin }} run agentstack-server:migrations:alembic revision --autogenerate"

# dev

["agentstack-server:dev:shell"]
dir = "{{config_root}}/apps/agentstack-server"
run = "{{ mise_bin }} run agentstack:shell --vm-name=agentstack-local-dev"

["agentstack-server:dev:start"]
dir = "{{config_root}}/apps/agentstack-server"
usage = '''
flag "--vm-name <vm_name>" default="agentstack-local-dev"
arg "[cli_args]..."
'''
run = """
#!/bin/bash

set -e
VM_NAME="${usage_vm_name?}"
eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"
{{ mise_bin }} run agentstack-server:dev:disconnect --vm-name="$VM_NAME"
{{ mise_bin }} run agentstack:stop-all --except "$VM_NAME"
eval "cli_args=(${usage_cli_args})"
export SKIP_PULL
{{ mise_bin }} agentstack:start --vm-name="$VM_NAME" \
    --no-wait-for-platform \
    --set externalRegistries=null \
    "${cli_args[@]}"
{{ mise_bin }} run agentstack-server:dev:connect --vm-name="$VM_NAME"
"""

["agentstack-server:dev:reload"]
dir = "{{config_root}}/apps/agentstack-server"
usage = '''
arg "[cli_args]..."
'''
run = """
#!/bin/bash
eval "cli_args=(${usage_cli_args})"
{{ mise_bin }} run --force helm:build
{{ mise_bin }} run --force agentstack-cli:build:copy-helm-chart
SKIP_PULL=true {{ mise_bin }} run agentstack-server:dev:start "${cli_args[@]}"
"""

["agentstack-server:dev:stop"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--vm-name <vm_name>" default="agentstack-local-dev"'
run = """
#!/bin/bash
VM_NAME="${usage_vm_name?}"
{{ mise_bin }} run agentstack-server:dev:disconnect --vm-name="$VM_NAME"
{{ mise_bin }} run agentstack:stop --vm-name="$VM_NAME"
"""

["agentstack-server:dev:delete"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--vm-name <vm_name>" default="agentstack-local-dev"'
run = """
VM_NAME="${usage_vm_name?}"
{{ mise_bin }} run agentstack-cli:run -- platform delete --vm-name="$VM_NAME"
"""

["agentstack-server:dev:connect"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--vm-name <vm_name>" default="agentstack-local-dev"'
run = """
#!/bin/bash
NAMESPACE=default
VM_NAME="${usage_vm_name?}"
eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"

# MicroShift/OpenShift specific setup for Telepresence
kubectl create namespace ambassador --dry-run=client -o yaml | kubectl apply -f -
kubectl label namespace ambassador pod-security.kubernetes.io/enforce=privileged --overwrite
kubectl label namespace ambassador pod-security.kubernetes.io/warn=privileged --overwrite
kubectl label namespace ambassador pod-security.kubernetes.io/audit=privileged --overwrite

# Create telepresence values file to handle MicroShift restricted SCC
TP_VALUES=$(mktemp)
cat > "$TP_VALUES" <<EOF
podSecurityContext: {}
securityContext:
  runAsUser: null
  runAsNonRoot: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
EOF

tele="telepresence --use .*${NAMESPACE}.*"
$tele helm install --values "$TP_VALUES" || true
rm "$TP_VALUES"
$tele connect --namespace "$NAMESPACE"
$tele replace agentstack-server --port 18333:8333
"""

["agentstack-server:dev:disconnect"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--vm-name <vm_name>" default="agentstack-local-dev"'
run = """
#!/bin/bash
NAMESPACE=default
VM_NAME="${usage_vm_name?}"
eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"

tele="telepresence --use .*${NAMESPACE}.*"
if ! ($tele status --output json | jq '.user_daemon.status' | grep -q "Not connected"); then
    $tele uninstall --all-agents || true
fi
$tele quit
"""

["agentstack-server:dev:reconnect"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--vm-name <vm_name>" default="agentstack-local-dev"'
run = """
VM_NAME="${usage_vm_name?}"
{{ mise_bin }} run agentstack-server:dev:disconnect --vm-name="$VM_NAME"
{{ mise_bin }} run agentstack-server:dev:connect --vm-name="$VM_NAME"
"""

["agentstack-server:test:unit"]
dir = "{{config_root}}/apps/agentstack-server"
run = "uv run pytest -m unit"

["agentstack-server:test:e2e"]
dir = "{{config_root}}/apps/agentstack-server"
usage = '''
flag "--no-clean"
flag "--only <only>"
'''
run = """
#!/bin/bash
set -euxo pipefail

VM_NAME=e2e-test-run

export AGENTSTACK__USERNAME=admin
export AGENTSTACK__PASSWORD=admin
export AGENTSTACK__CLIENT_ID=agentstack-cli

NO_CLEAN="${usage_no_clean:-false}"
if [ "$NO_CLEAN" != "true" ]; then
    {{ mise_bin }} run agentstack:stop-all
    {{ mise_bin }} run agentstack:delete --vm-name=${VM_NAME} || true
    curl http://localhost:8333 >/dev/null 2>&1 && echo "Another instance at localhost:8333 is already running" && exit 2
fi

CONFIG_FILE="/tmp/config_e2e_test_$(date +%s).yaml"

echo '
externalRegistries: null
ui:
  enabled: false
auth:
  enabled: true
docling:
  enabled: true
connector:
  presets:
    - url: mcp+stdio://test
      stdio:
        image: mcp/aws-documentation
      metadata:
        name: Test MCP Server
keycloak:
  auth:
    seedAgentstackUsers:
      - username: admin
        password: admin
        firstName: Admin
        lastName: User
        email: admin@beeai.dev
        roles: ["agentstack-admin"]
' > "$CONFIG_FILE"

{{ mise_bin }} run agentstack:start -v --vm-name=${VM_NAME} --skip-login -f "$CONFIG_FILE" --set ui.enabled=false

eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"

if [ -z "${TEST_AGENT_IMAGE:-}" ]; then
    echo "Building test agent..."
    TEST_AGENT_IMAGE=agentstack-registry-svc.default:5001/chat-test:latest
    {{ mise_bin }} run agentstack-cli:run -- client-side-build -v "${PWD}/../.." --vm-name=${VM_NAME} --dockerfile "${PWD}/../../agents/chat/Dockerfile" --tag ${TEST_AGENT_IMAGE}
fi
export TEST_AGENT_IMAGE

export DB_URL="postgresql+asyncpg://agentstack-user:password@localhost:5432/agentstack"
export LLM_API_BASE="${LLM_API_BASE:-http://host.docker.internal:11434/v1}"

echo "Waiting for agentstack-server deployment to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment/agentstack-server

echo "Waiting for Keycloak provision job to complete..."                                                                                                                                                                                                                                                                                                                                                                                     
kubectl wait --for=condition=complete --timeout=300s job/keycloak-provision

kubectl port-forward svc/postgresql 5432:5432 2>/dev/null 1>&2 &
uv run pytest -m e2e --ignore=tests/e2e/examples
result=$?

if [ $result -ne 0 ]; then
    echo "Tests failed. Checking pod status..."
    echo "------------- pods --------------"
    kubectl get pod
    echo "------------ events -------------"
    kubectl get event
fi

if [ "$NO_CLEAN" != "true" ]; then
    {{ mise_bin }} run agentstack-cli:run -- platform delete --vm-name=${VM_NAME}
else
    {{ mise_bin }} run agentstack-cli:run -- platform stop --vm-name=${VM_NAME}
fi

rm -f "$CONFIG_FILE"

kill %1
exit $result
"""

["agentstack-server:test:e2e-examples"]
dir = "{{config_root}}/apps/agentstack-server"
usage = 'flag "--no-clean"'
run = """
#!/bin/bash
VM_NAME=e2e-examples-test-run

export AGENTSTACK__USERNAME=admin
export AGENTSTACK__PASSWORD=admin
export AGENTSTACK__CLIENT_ID=agentstack-cli

NO_CLEAN="${usage_no_clean:-false}"
if [ "$NO_CLEAN" != "true" ]; then
    {{ mise_bin }} run agentstack:stop-all
    {{ mise_bin }} run agentstack:delete --vm-name=${VM_NAME}
    curl http://localhost:8333 >/dev/null 2>&1 && echo "Another instance at localhost:8333 is already running" && exit 2
fi

CONFIG_FILE="/tmp/config_e2e_test_$(date +%s).yaml"

echo '
externalRegistries: null
ui:
  enabled: false
auth:
  enabled: true
docling:
  enabled: true
connector:
  presets:
    - url: mcp+stdio://test
      stdio:
        image: mcp/aws-documentation
      metadata:
        name: Test MCP Server
keycloak:
  auth:
    seedAgentstackUsers:
      - username: admin
        password: admin
        firstName: Admin
        lastName: User
        email: admin@beeai.dev
        roles: ["agentstack-admin"]
' > "$CONFIG_FILE"

{{ mise_bin }} run agentstack:start --vm-name=${VM_NAME} --skip-login -f "$CONFIG_FILE" --set ui.enabled=false


eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"

export DB_URL="postgresql+asyncpg://agentstack-user:password@localhost:5432/agentstack"
export LLM_API_BASE="${LLM_API_BASE:-http://host.docker.internal:11434/v1}"

echo "Waiting for agentstack-server deployment to be ready..."
kubectl wait --for=condition=available --timeout=300s deployment/agentstack-server

echo "Waiting for Keycloak provision job to complete..."
kubectl wait --for=condition=complete --timeout=300s job/keycloak-provision

kubectl port-forward svc/postgresql 5432:5432 2>/dev/null 1>&2 &
uv run pytest -m e2e tests/e2e/examples
result=$?

if [ $result -ne 0 ]; then
    echo "Tests failed. Checking pod status..."
    echo "------------- pods --------------"
    kubectl get pod
    echo "------------ events -------------"
    kubectl get event
fi

if [ "$NO_CLEAN" != "true" ]; then
    {{ mise_bin }} run agentstack-cli:run -- platform delete --vm-name=${VM_NAME}
else
    {{ mise_bin }} run agentstack-cli:run -- platform stop --vm-name=${VM_NAME}
fi

rm -f "$CONFIG_FILE"

kill %1
exit $result
"""

["agentstack-server:test:integration"]
dir = "{{config_root}}/apps/agentstack-server"
run = """
#!/bin/bash
set -euxo pipefail
VM_NAME=integration-test-run

{{ mise_bin }} run agentstack:delete --vm-name="$VM_NAME"

{{ mise_bin }} run agentstack:start \
    --vm-name="$VM_NAME" \
    --set externalRegistries=null \
    --set redis.enabled=true \
    --set ui.enabled=false

eval "$( {{ mise_bin }} run agentstack:shell --vm-name="$VM_NAME" )"

{{ mise_bin }} run agentstack-server:dev:connect --vm-name="$VM_NAME"

uv run pytest -m integration
"""
