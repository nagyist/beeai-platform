{{- $jwtPrivateKey := .Values.auth.jwtPrivateKey -}}
{{- $jwtPublicKey := .Values.auth.jwtPublicKey -}}

{{- if and (empty $jwtPrivateKey) (empty $jwtPublicKey) -}}
  {{- $secret := (lookup "v1" "Secret" .Release.Namespace "agentstack-secret") -}}
  {{- if and $secret $secret.data -}}
    {{- if and (hasKey $secret.data "jwtPrivateKey") (hasKey $secret.data "jwtPublicKey") -}}
      {{- $jwtPrivateKey = index $secret.data "jwtPrivateKey" | b64dec -}}
      {{- $jwtPublicKey = index $secret.data "jwtPublicKey" | b64dec -}}
    {{- end -}}
  {{- end -}}

  {{- if and (empty $jwtPrivateKey) (empty $jwtPublicKey) -}}
    {{- $gen := genSelfSignedCert "agentstack-jwt" nil nil 3650 -}}
    {{- $jwtPrivateKey = $gen.Key -}}
    {{- $jwtPublicKey = $gen.Cert -}}
  {{- end -}}
{{- end -}}
apiVersion: v1
kind: Secret
metadata:
  name: "agentstack-secret"
  labels:
    app: agentstack-server
    {{- include "agentstack.labels" . | nindent 4 }}
type: Opaque

data:
  encryptionKey: {{ .Values.encryptionKey | b64enc | quote }}
  sqlConnection: {{ printf "postgresql+asyncpg://%s:%s@%s:%s/%s"
       (include "agentstack.databaseUser" .)
       (include "agentstack.databasePassword" .)
       (include "agentstack.databaseHost" .)
       (include "agentstack.databasePort" .)
       (include "agentstack.databaseName" .)
       | b64enc | quote
  }}
  {{- if and .Values.postgresql.enabled .Values.postgresql.auth.enablePostgresUser }}
  sqlConnectionSuperuser: {{ printf "postgresql+asyncpg://%s:%s@%s:%s/%s"
       (include "agentstack.databaseAdminUser" .)
       (include "agentstack.databaseAdminPassword" .)
       (include "agentstack.databaseHost" .)
       (include "agentstack.databasePort" .)
       (include "agentstack.databaseName" .)
       | b64enc | quote
  }}
  {{- end }}
  jwtPrivateKey: {{ $jwtPrivateKey | b64enc | quote }}
  jwtPublicKey: {{ $jwtPublicKey | b64enc | quote }}
  s3AccessKeyId: {{ include "agentstack.s3.accessKeyID" . | b64enc | quote }}
  s3AccessKeySecret: {{ include "agentstack.s3.accessKeySecret" . | b64enc | quote }}
  {{- if .Values.github.auths }}
  .githubconfigjson: {{ .Values.github | toJson | b64enc | quote }}
  {{- end }}
  {{- if .Values.providerBuilds.externalClusterExecutor.kubeconfig }}
  providerBuildExternalClusterKubeconfig: {{ .Values.providerBuilds.externalClusterExecutor.kubeconfig | b64enc | quote }}
  {{- end }}
  {{- if and (include "agentstack.databaseSslEnabled" .) .Values.externalDatabase.sslRootCert }}
  sslRootCert: {{ .Values.externalDatabase.sslRootCert | b64enc | quote }}
  {{- end }}
  {{- if or .Values.keycloak.enabled (not .Values.externalOidcProvider.existingSecret) }}
  {{- $serverClientSecret := include "agentstack.oidc.serverClientSecretValue" . }}
  agentstackServerClientSecret: {{ $serverClientSecret | b64enc | quote }}
  {{- end }}
